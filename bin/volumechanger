#!/usr/bin/env bash

# depends: dzen2, dbar

IF="Master"
IF_HP="Headphone"
CARD=1
SLEEP_SECS="1"

FONT="terminus-12"
BG="#B58900"
FG="#FDF6E3"
PANEL_WIDTH=272

SCREEN_SIZE=$(xdpyinfo | grep dimensions | cut -d ' ' -f 7)
SCREEN_WIDTH=$(echo ${SCREEN_SIZE} | cut -d 'x' -f 1)
SCREEN_HEIGHT=$(echo ${SCREEN_SIZE} | cut -d 'x' -f 2)

let "XPOS = SCREEN_WIDTH / 2 - PANEL_WIDTH / 2"
let "YPOS = SCREEN_HEIGHT / 2"

# pipe
PIPE="/tmp/dvolpipe"

err() {
	echo "$1"
	exit 1
}

usage() {
	echo "usage: volumechanger.sh [option] [argument]"
	echo
	echo "Options:"
	echo "	-i, --increase - increase volume by 'argument'"
	echo "	-d, --decrease - decrease volume by 'argument'"
	echo "	-t, --toggle   - toggle mute on and off"
	echo "	-h, --help     - display this"
	exit
}

# argument parsing
case "$1" in
	'-i'|'--increase')
		[ -z "$2" ] && err "No argument specified for increase."
		AMIXARG="${2}%+"
	;;
	'-d'|'--decrease')
		[ -z "$2" ] && err "No argument specified for decrease."
		AMIXARG="${2}%-"
	;;
	'-t'|'--toggle')
		AMIXARG="toggle"
	;;
	''|'-h'|'--help')
		usage
	;;
	*)
		err "Unrecognized option '$1', see $0 --help"
	;;
esac

# check headphone
if [[ -n "$(amixer -c $CARD get Headphone | grep '\[on\]')" && "$AMIXARG" != "toggle" ]]; then
	IF="$IF_HP"
fi

# actual volume changing (readability low)
AMIXOUT="$(amixer -c $CARD set "$IF" "$AMIXARG" | tail -n 1)"
MUTE="$(cut -d '[' -f 4 <<<"$AMIXOUT")"
if [ "$MUTE" = "off]" ]; then
	VOL="0"
else
	VOL="$(cut -d '[' -f 2 <<<"$AMIXOUT" | sed 's/%.*//g')"
fi

# using named pipe to determine whether previous call still exists
# also prevents multiple volume bar instances
if [ ! -e "$PIPE" ]; then
	mkfifo "$PIPE"
	(dzen2 -l 1 -x "$XPOS" -y "$YPOS" -w "$PANEL_WIDTH" -fn "$FONT" -bg "$BG" -fg "$FG" -e 'onstart=uncollapse' < "$PIPE"
	rm -f "$PIPE") &
fi

# feed the pipe!
(echo "Volume ($IF)" ; echo "$VOL" | dbar ; sleep "$SLEEP_SECS") > "$PIPE"
